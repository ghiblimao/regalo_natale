<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcade iPhone 15 v2</title>
    <style>
        /* --- STILE GENERALE --- */
        body {
            background-color: #121212;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        h1 { margin: 0 0 20px 0; font-size: 2rem; }
        
        /* MENU */
        #menu { display: flex; flex-direction: column; gap: 15px; width: 80%; }
        .btn {
            background: linear-gradient(45deg, #007AFF, #00C6FF);
            border: none;
            padding: 20px;
            border-radius: 15px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
            cursor: pointer;
        }
        .btn:active { transform: scale(0.98); }

        /* GIOCHI */
        .game-container {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            background: #1e1e1e;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .back-btn {
            position: absolute;
            top: 50px; left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 8px;
            color: white;
            border: none;
            z-index: 100;
            font-weight: bold;
        }

        /* INFO BAR (Punteggio e Timer) */
        .info-bar {
            position: absolute;
            top: 50px; right: 20px;
            text-align: right;
            z-index: 100;
        }
        .score-txt { font-size: 1.2rem; font-weight: bold; color: #FFD60A; }
        .timer-txt { font-size: 1rem; color: #aaa; margin-top: 5px; }

        canvas { background: #000; display: block; border: 1px solid #333; }
        
        /* MEMORY STYLES */
        #memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 90%;
            max-width: 350px;
        }
        .card {
            background-color: #333;
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
        }
        .card.flipped { background-color: #fff; color: #000; }
        
        /* REFLEX STYLES */
        #reflex-area {
            width: 90%; height: 60%;
            background: #222;
            position: relative;
            border-radius: 10px;
            border: 2px solid #333;
        }
        #target-dot {
            width: 60px; height: 60px;
            background-color: #FF3B30;
            border-radius: 50%;
            position: absolute;
            display: none;
        }

    </style>
</head>
<body>

    <div id="menu">
        <h1 style="text-align:center">üïπÔ∏è Arcade v2</h1>
        <button class="btn" onclick="startGame('flappy')">üê¶ Flappy (Obj: 15)</button>
        <button class="btn" onclick="startGame('memory')">üß† Memory (1 min)</button>
        <button class="btn" onclick="startGame('reflex')">‚ö° Reflex (Obj: 25)</button>
        <button class="btn" onclick="startGame('dodger')">üèéÔ∏è Schiva (Obj: 25)</button>
    </div>

    <div id="ui-overlay" style="display:none">
        <button class="back-btn" onclick="stopGame()">Indietro</button>
        <div class="info-bar">
            <div id="score-display" class="score-txt">Punti: 0</div>
            <div id="timer-display" class="timer-txt">Tempo: 0s</div>
        </div>
    </div>

    <div id="game-flappy" class="game-container"><canvas id="canvas-flappy"></canvas></div>
    <div id="game-memory" class="game-container"><div id="memory-grid"></div></div>
    <div id="game-reflex" class="game-container"><div id="reflex-area"><div id="target-dot" ontouchstart="hitTarget(event)"></div></div></div>
    <div id="game-dodger" class="game-container"><canvas id="canvas-dodger"></canvas></div>

    <script>
        let gameLoopId = null;     // ID per requestAnimationFrame
        let timerIntervalId = null; // ID per setInterval del tempo
        let timeLeft = 0;
        let currentScore = 0;
        let isGameOver = false;

        // Riferimenti UI
        const scoreEl = document.getElementById('score-display');
        const timerEl = document.getElementById('timer-display');
        const uiOverlay = document.getElementById('ui-overlay');

        function updateUI(score, time) {
            scoreEl.innerText = "Punti: " + score;
            if(time !== null) timerEl.innerText = "Tempo: " + time + "s";
            else timerEl.innerText = "";
        }

        // --- GESTIONE MENU ---
        function startGame(gameId) {
            document.getElementById('menu').style.display = 'none';
            document.querySelectorAll('.game-container').forEach(el => el.style.display = 'none');
            document.getElementById('game-' + gameId).style.display = 'flex';
            uiOverlay.style.display = 'block';
            
            isGameOver = false;
            currentScore = 0;
            
            if(gameId === 'flappy') initFlappy();
            if(gameId === 'memory') initMemory();
            if(gameId === 'reflex') initReflex();
            if(gameId === 'dodger') initDodger();
        }

        function stopGame() {
            // Pulizia totale
            clearInterval(timerIntervalId);
            cancelAnimationFrame(gameLoopId);
            isGameOver = true;

            document.getElementById('menu').style.display = 'flex';
            uiOverlay.style.display = 'none';
            document.querySelectorAll('.game-container').forEach(el => el.style.display = 'none');
        }

        function endGame(message) {
            isGameOver = true;
            clearInterval(timerIntervalId);
            cancelAnimationFrame(gameLoopId);
            // Piccolo ritardo per permettere al render di finire
            setTimeout(() => {
                alert(message);
                stopGame();
            }, 100);
        }

        // --------------------------------------------------------
        // 1. FLAPPY CUBE (Timer 20s, Obiettivo 15, Win anche se muori dopo 15)
        // --------------------------------------------------------
        function initFlappy() {
            const canvas = document.getElementById('canvas-flappy');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 0.95;
            canvas.height = window.innerHeight * 0.7;
            
            let birdY = canvas.height / 2;
            let birdX = 50;
            let velocity = 0;
            let gravity = 0.5;
            let pipes = [];
            
            timeLeft = 20;
            updateUI(0, timeLeft);

            // Timer
            timerIntervalId = setInterval(() => {
                timeLeft--;
                updateUI(currentScore, timeLeft);
                if(timeLeft <= 0) {
                    if(currentScore >= 15) endGame("‚è±Ô∏è Tempo scaduto! VITTORIA (Punti: " + currentScore + ")");
                    else endGame("‚è±Ô∏è Tempo scaduto! Perso. (Servivano 15, fatti: " + currentScore + ")");
                }
            }, 1000);

            // Input
            canvas.ontouchstart = (e) => {
                e.preventDefault();
                if(!isGameOver) velocity = -8;
            };

            function loop() {
                if(isGameOver) return;

                // Logica
                velocity += gravity;
                birdY += velocity;

                // Generazione tubi
                if(frames % 90 === 0) {
                    // Crea tubo con flag 'counted' per contare punti una volta sola
                    pipes.push({x: canvas.width, h: Math.random() * (canvas.height/2), counted: false});
                }

                // Disegno
                ctx.fillStyle = '#1e1e1e';
                ctx.fillRect(0,0,canvas.width, canvas.height);

                // Player
                ctx.fillStyle = '#00C6FF';
                ctx.fillRect(birdX, birdY, 30, 30);

                // Tubi
                ctx.fillStyle = '#4CAF50';
                for(let i = 0; i < pipes.length; i++) {
                    let p = pipes[i];
                    p.x -= 3; // Velocit√† scorrimento

                    // Disegna
                    ctx.fillRect(p.x, 0, 40, p.h); 
                    ctx.fillRect(p.x, p.h + 130, 40, canvas.height); 

                    // Conteggio Punti (pi√π preciso)
                    if(!p.counted && p.x + 40 < birdX) {
                        currentScore++;
                        p.counted = true;
                        updateUI(currentScore, timeLeft);
                    }

                    // Collisione
                    if(birdX < p.x + 40 && birdX + 30 > p.x && (birdY < p.h || birdY + 30 > p.h + 130)) {
                        if(currentScore >= 15) endGame("üí• Incidente! Ma hai vinto comunque! (" + currentScore + " pt)");
                        else endGame("üí• Incidente! Perso (Servivano 15, fatti: " + currentScore + ")");
                        return;
                    }
                }

                // Pavimento/Soffitto
                if(birdY > canvas.height || birdY < 0) {
                    if(currentScore >= 15) endGame("üí• Caduto! Ma hai vinto comunque! (" + currentScore + " pt)");
                    else endGame("üí• Caduto! Perso.");
                    return;
                }

                frames++;
                gameLoopId = requestAnimationFrame(loop);
            }
            let frames = 0;
            loop();
        }

        // --------------------------------------------------------
        // 2. MEMORY EMOJI (Timer 1 min, Perso se scade)
        // --------------------------------------------------------
        function initMemory() {
            const grid = document.getElementById('memory-grid');
            grid.innerHTML = '';
            
            // 8 coppie
            const emojis = ['üê∂','üê∂','üê±','üê±','üê≠','üê≠','üêπ','üêπ','ü¶ä','ü¶ä','üêª','üêª','üêº','üêº','üê®','üê®'];
            emojis.sort(() => 0.5 - Math.random());
            
            let flippedCards = [];
            let matched = 0;
            timeLeft = 60;
            currentScore = 0; // Coppie trovate
            
            updateUI(0, timeLeft);

            timerIntervalId = setInterval(() => {
                timeLeft--;
                updateUI(matched, timeLeft);
                if(timeLeft <= 0) {
                    endGame("‚è±Ô∏è Tempo scaduto! Non hai trovato tutte le coppie.");
                }
            }, 1000);

            emojis.forEach(emoji => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.val = emoji;
                
                card.ontouchstart = (e) => {
                    e.preventDefault(); // Previene doppio tap zoom
                    if(isGameOver) return;
                    
                    if(flippedCards.length < 2 && !card.classList.contains('flipped')) {
                        card.classList.add('flipped');
                        card.innerText = emoji;
                        flippedCards.push(card);
                        
                        if(flippedCards.length === 2) {
                            // Controllo match
                            if(flippedCards[0].dataset.val === flippedCards[1].dataset.val) {
                                flippedCards = [];
                                matched++;
                                updateUI(matched, timeLeft);
                                if(matched === 8) endGame("üèÜ VITTORIA! Hai trovato tutte le coppie!");
                            } else {
                                setTimeout(() => {
                                    if(!isGameOver) {
                                        flippedCards.forEach(c => { c.classList.remove('flipped'); c.innerText = ''; });
                                        flippedCards = [];
                                    }
                                }, 600);
                            }
                        }
                    }
                };
                grid.appendChild(card);
            });
        }

        // --------------------------------------------------------
        // 3. REFLEX DOT (Timer 20s, Obiettivo > 25)
        // --------------------------------------------------------
        function initReflex() {
            timeLeft = 20;
            currentScore = 0;
            updateUI(0, timeLeft);
            
            moveDot();

            timerIntervalId = setInterval(() => {
                timeLeft--;
                updateUI(currentScore, timeLeft);
                if(timeLeft <= 0) {
                    if(currentScore >= 25) endGame("üèÜ VITTORIA! Riflessi ottimi (" + currentScore + " click)");
                    else endGame("üê¢ Troppo lento... Fatti: " + currentScore + " (Target: 25)");
                }
            }, 1000);
        }

        function moveDot() {
            if(isGameOver) return;
            const area = document.getElementById('reflex-area');
            const dot = document.getElementById('target-dot');
            
            // Margini di sicurezza per non farlo uscire
            const maxX = area.clientWidth - 70;
            const maxY = area.clientHeight - 70;
            
            const x = Math.floor(Math.random() * maxX);
            const y = Math.floor(Math.random() * maxY);
            
            dot.style.display = 'block';
            dot.style.left = x + 'px';
            dot.style.top = y + 'px';
        }

        window.hitTarget = function(e) {
            e.preventDefault(); // Evita zoom
            if(isGameOver) return;
            currentScore++;
            updateUI(currentScore, timeLeft);
            moveDot();
        }

        // --------------------------------------------------------
        // 4. SCHIVA TUTTO (Vittoria a 25 ostacoli)
        // --------------------------------------------------------
        function initDodger() {
            const canvas = document.getElementById('canvas-dodger');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 0.95;
            canvas.height = window.innerHeight * 0.7;
            
            let playerX = canvas.width / 2 - 20;
            let obstacles = [];
            currentScore = 0;
            
            updateUI(0, null); // Niente timer qui

            canvas.ontouchstart = (e) => {
                e.preventDefault();
                let touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
                if(touchX < canvas.width / 2) playerX -= 50;
                else playerX += 50;
                
                // Mantiene player nei bordi
                if(playerX < 0) playerX = 0;
                if(playerX > canvas.width - 40) playerX = canvas.width - 40;
            };

            function loop() {
                if(isGameOver) return;

                ctx.fillStyle = '#222';
                ctx.fillRect(0,0,canvas.width, canvas.height);

                // Player
                ctx.fillStyle = '#FF9500';
                ctx.fillRect(playerX, canvas.height - 60, 40, 40);

                // Genera Ostacoli
                if(Math.random() < 0.04) {
                    obstacles.push({x: Math.random() * (canvas.width - 40), y: -40});
                }

                ctx.fillStyle = '#FF3B30';
                // Loop inverso per poter rimuovere elementi
                for(let i = obstacles.length - 1; i >= 0; i--) {
                    let o = obstacles[i];
                    o.y += 6; // Velocit√† discesa
                    ctx.fillRect(o.x, o.y, 40, 40);

                    // Collisione
                    if(o.y > canvas.height - 100 && o.y < canvas.height - 20 && 
                       o.x < playerX + 40 && o.x + 40 > playerX) {
                        endGame("üí• SCHIANTATO! Punteggio finale: " + currentScore);
                        return;
                    }

                    // Ostacolo superato
                    if(o.y > canvas.height) { 
                        obstacles.splice(i, 1); 
                        currentScore++; 
                        updateUI(currentScore, null);
                        
                        // VITTORIA A 25
                        if(currentScore >= 25) {
                            endGame("üèÜ CAMPIONE! Hai schivato 25 ostacoli!");
                            return;
                        }
                    }
                }

                gameLoopId = requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>
