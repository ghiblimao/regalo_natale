<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcade Union Jack Edition</title>
    <style>
        :root {
            --royal-blue: #00215F;
            --bright-red: #CF142B;
            --pure-white: #FFFFFF;
            --text-color-light: #F0F0F0;
            --dark-background: #001A4A;
            --accent-green: #00A65A;
        }

        /* --- STILE GENERALE --- */
        body {
            background-color: var(--dark-background);
            color: var(--text-color-light);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        h1 { margin: 0 0 20px 0; font-size: 2rem; color: var(--pure-white); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        /* MENU */
        #menu { display: flex; flex-direction: column; gap: 15px; width: 85%; z-index: 10; }
        
        .btn {
            background-color: var(--royal-blue);
            border: 2px solid var(--pure-white);
            padding: 20px;
            border-radius: 16px;
            color: var(--pure-white);
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); background-color: var(--dark-background); }

        /* ISTRUZIONI POPUP */
        #instruction-panel {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 26, 74, 0.98); /* Dark BG con trasparenza */
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            box-sizing: border-box;
            text-align: center;
        }
        #inst-title { font-size: 2rem; color: var(--pure-white); margin-bottom: 20px; border-bottom: 2px solid var(--bright-red); padding-bottom: 10px; }
        #inst-desc { font-size: 1.1rem; line-height: 1.6; color: var(--text-color-light); margin-bottom: 40px; }
        
        .btn-start { 
            background-color: var(--accent-green); 
            border: none;
            color: var(--pure-white);
            box-shadow: 0 0 15px rgba(0, 166, 90, 0.4); 
        }
        .btn-cancel { 
            background: transparent; 
            border: 1px solid var(--text-color-light); 
            color: var(--text-color-light);
            margin-top: 15px; 
            font-size: 1rem; 
            padding: 15px; 
        }

        /* GIOCHI UI */
        .game-container {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            background: var(--dark-background);
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .back-btn {
            position: absolute;
            top: 50px; left: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--pure-white);
            padding: 8px 15px;
            border-radius: 8px;
            color: var(--pure-white);
            z-index: 100;
            font-weight: bold;
        }

        /* INFO BAR (Punteggio e Timer) */
        .info-bar {
            position: absolute;
            top: 50px; right: 20px;
            text-align: right;
            z-index: 100;
        }
        .score-txt { font-size: 1.3rem; font-weight: bold; color: var(--pure-white); }
        .timer-txt { font-size: 1rem; color: var(--bright-red); margin-top: 5px; font-weight: bold;}

        /* CANVAS */
        canvas { 
            background-color: var(--royal-blue); 
            display: block; 
            border: 3px solid var(--pure-white); 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        
        /* MEMORY STYLES */
        #memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 90%;
            max-width: 350px;
        }
        .card {
            background-color: var(--royal-blue);
            border: 2px solid var(--pure-white);
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .card.flipped { background-color: var(--pure-white); color: #000; border-color: var(--accent-green); }
        
        /* REFLEX STYLES */
        #reflex-area {
            width: 90%; height: 60%;
            background: var(--royal-blue);
            position: relative;
            border-radius: 10px;
            border: 3px solid var(--pure-white);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #target-dot {
            width: 60px; height: 60px;
            background-color: var(--bright-red);
            border: 2px solid var(--pure-white);
            border-radius: 50%;
            position: absolute;
            display: none;
            box-shadow: 0 0 10px var(--bright-red);
        }

    </style>
</head>
<body>

    <div id="menu">
        <h1 style="text-align:center">üïπÔ∏è Arcade Room</h1>
        <button class="btn" onclick="prepareGame('flappy')">üê¶ Flappy Cube</button>
        <button class="btn" onclick="prepareGame('memory')">üß† Memory Emoji</button>
        <button class="btn" onclick="prepareGame('reflex')">‚ö° Reflex Dot</button>
        <button class="btn" onclick="prepareGame('dodger')">üèéÔ∏è Schiva Tutto</button>
    </div>

    <div id="instruction-panel">
        <h2 id="inst-title">Titolo Gioco</h2>
        <p id="inst-desc">Descrizione regole...</p>
        <button class="btn btn-start" onclick="launchGame()">üöÄ GIOCA ORA</button>
        <button class="btn btn-cancel" onclick="closeInstructions()">Annulla</button>
    </div>

    <div id="ui-overlay" style="display:none">
        <button class="back-btn" onclick="stopGame()">Esci</button>
        <div class="info-bar">
            <div id="score-display" class="score-txt">Punti: 0</div>
            <div id="timer-display" class="timer-txt">Tempo: 0s</div>
        </div>
    </div>

    <div id="game-flappy" class="game-container"><canvas id="canvas-flappy"></canvas></div>
    <div id="game-memory" class="game-container"><div id="memory-grid"></div></div>
    <div id="game-reflex" class="game-container"><div id="reflex-area"><div id="target-dot" ontouchstart="hitTarget(event)"></div></div></div>
    <div id="game-dodger" class="game-container"><canvas id="canvas-dodger"></canvas></div>

    <script>
        // CONFIGURAZIONE COLORI JS (Per Canvas)
        const COLORS = {
            bg: '#00215F',      // royal-blue
            player: '#FFFFFF',  // pure-white
            obstacle: '#CF142B',// bright-red
            safe: '#00A65A',    // accent-green
            text: '#F0F0F0'     // light-text
        };

        let gameLoopId = null;
        let timerIntervalId = null;
        let timeLeft = 0;
        let currentScore = 0;
        let isGameOver = false;
        let selectedGameId = '';

        // TESTI ISTRUZIONI
        const INSTRUCTIONS = {
            'flappy': {
                title: "üê¶ Flappy Cube",
                desc: "Tocca lo schermo per volare.<br><br><b>OBIETTIVO:</b> Supera almeno <b>5 ostacoli</b> in 20 secondi.<br><br>Se superi 5 ostacoli, vinci anche se poi ti schianti!"
            },
            'memory': {
                title: "üß† Memory Emoji",
                desc: "Tocca le caselle blu per girarle.<br><br><b>OBIETTIVO:</b> Trova tutte le 8 coppie prima che scada il timer di <b>60 secondi</b>."
            },
            'reflex': {
                title: "‚ö° Reflex Dot",
                desc: "Tocca il pallino rosso non appena appare.<br><br><b>OBIETTIVO:</b> Colpisci <b>25 pallini</b> in 20 secondi."
            },
            'dodger': {
                title: "üèéÔ∏è Schiva Tutto",
                desc: "Tocca a DESTRA o SINISTRA per muoverti.<br><br><b>OBIETTIVO:</b> Schiva i blocchi rossi. Raggiungi <b>25 punti</b> per vincere."
            }
        };

        const uiOverlay = document.getElementById('ui-overlay');
        const scoreEl = document.getElementById('score-display');
        const timerEl = document.getElementById('timer-display');

        function updateUI(score, time) {
            scoreEl.innerText = "Punti: " + score;
            if(time !== null) timerEl.innerText = "Tempo: " + time + "s";
            else timerEl.innerText = "";
        }

        // --- GESTIONE FLUSSO ---
        function prepareGame(gameId) {
            selectedGameId = gameId;
            const data = INSTRUCTIONS[gameId];
            document.getElementById('inst-title').innerText = data.title;
            document.getElementById('inst-desc').innerHTML = data.desc;
            document.getElementById('instruction-panel').style.display = 'flex';
        }

        function closeInstructions() {
            document.getElementById('instruction-panel').style.display = 'none';
        }

        function launchGame() {
            closeInstructions();
            document.getElementById('menu').style.display = 'none';
            document.querySelectorAll('.game-container').forEach(el => el.style.display = 'none');
            document.getElementById('game-' + selectedGameId).style.display = 'flex';
            uiOverlay.style.display = 'block';
            
            isGameOver = false;
            currentScore = 0;
            
            if(selectedGameId === 'flappy') initFlappy();
            if(selectedGameId === 'memory') initMemory();
            if(selectedGameId === 'reflex') initReflex();
            if(selectedGameId === 'dodger') initDodger();
        }

        function stopGame() {
            clearInterval(timerIntervalId);
            cancelAnimationFrame(gameLoopId);
            isGameOver = true;
            document.getElementById('menu').style.display = 'flex';
            uiOverlay.style.display = 'none';
            document.querySelectorAll('.game-container').forEach(el => el.style.display = 'none');
        }

        function endGame(message) {
            isGameOver = true;
            clearInterval(timerIntervalId);
            cancelAnimationFrame(gameLoopId);
            setTimeout(() => {
                alert(message);
                stopGame();
            }, 100);
        }

        // --------------------------------------------------------
        // 1. FLAPPY CUBE (Palette Update)
        // --------------------------------------------------------
        function initFlappy() {
            const canvas = document.getElementById('canvas-flappy');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 0.95;
            canvas.height = window.innerHeight * 0.7;
            
            const TARGET_SCORE = 5;
            let birdY = canvas.height / 2;
            let birdX = 50;
            let velocity = 0;
            let gravity = 0.5;
            let pipes = [];
            
            timeLeft = 20;
            updateUI(0, timeLeft);

            timerIntervalId = setInterval(() => {
                timeLeft--;
                updateUI(currentScore, timeLeft);
                if(timeLeft <= 0) {
                    if(currentScore >= TARGET_SCORE) endGame("‚è±Ô∏è Tempo scaduto! VITTORIA (Obiettivo Raggiunto!)");
                    else endGame("‚è±Ô∏è Tempo scaduto! Perso. (Fatti: " + currentScore + "/5)");
                }
            }, 1000);

            canvas.ontouchstart = (e) => {
                e.preventDefault();
                if(!isGameOver) velocity = -8;
            };

            function loop() {
                if(isGameOver) return;
                velocity += gravity;
                birdY += velocity;

                if(frames % 90 === 0) {
                    pipes.push({x: canvas.width, h: Math.random() * (canvas.height/2), counted: false});
                }

                // Sfondo
                ctx.fillStyle = COLORS.bg;
                ctx.fillRect(0,0,canvas.width, canvas.height);

                // Player (Bianco)
                ctx.fillStyle = COLORS.player;
                ctx.fillRect(birdX, birdY, 30, 30);
                // Bordo player
                ctx.strokeStyle = COLORS.bg;
                ctx.strokeRect(birdX, birdY, 30, 30);

                // Tubi (Verdi)
                ctx.fillStyle = COLORS.safe;
                for(let i = 0; i < pipes.length; i++) {
                    let p = pipes[i];
                    p.x -= 3;
                    ctx.fillRect(p.x, 0, 40, p.h); 
                    ctx.fillRect(p.x, p.h + 130, 40, canvas.height); 
                    
                    // Bordi tubi per contrasto
                    ctx.strokeStyle = COLORS.player;
                    ctx.strokeRect(p.x, 0, 40, p.h);
                    ctx.strokeRect(p.x, p.h + 130, 40, canvas.height);

                    if(!p.counted && p.x + 40 < birdX) {
                        currentScore++;
                        p.counted = true;
                        updateUI(currentScore, timeLeft);
                    }

                    if(birdX < p.x + 40 && birdX + 30 > p.x && (birdY < p.h || birdY + 30 > p.h + 130)) {
                        if(currentScore >= TARGET_SCORE) endGame("üí• Incidente! Ma hai vinto (Obiettivo raggiunto: " + currentScore + ")");
                        else endGame("üí• Incidente! Perso (Fatti: " + currentScore + "/5)");
                        return;
                    }
                }

                if(birdY > canvas.height || birdY < 0) {
                    if(currentScore >= TARGET_SCORE) endGame("üí• Caduto! Ma hai vinto (Obiettivo raggiunto: " + currentScore + ")");
                    else endGame("üí• Caduto! Perso (Fatti: " + currentScore + "/5)");
                    return;
                }

                frames++;
                gameLoopId = requestAnimationFrame(loop);
            }
            let frames = 0;
            loop();
        }

        // --------------------------------------------------------
        // 2. MEMORY EMOJI (CSS gestisce i colori)
        // --------------------------------------------------------
        function initMemory() {
            const grid = document.getElementById('memory-grid');
            grid.innerHTML = '';
            const emojis = ['üê∂','üê∂','üê±','üê±','üê≠','üê≠','üêπ','üêπ','ü¶ä','ü¶ä','üêª','üêª','üêº','üêº','üê®','üê®'];
            emojis.sort(() => 0.5 - Math.random());
            
            let flippedCards = [];
            let matched = 0;
            timeLeft = 60;
            currentScore = 0;
            updateUI(0, timeLeft);

            timerIntervalId = setInterval(() => {
                timeLeft--;
                updateUI(matched, timeLeft);
                if(timeLeft <= 0) endGame("‚è±Ô∏è Tempo scaduto! Ritenta.");
            }, 1000);

            emojis.forEach(emoji => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.val = emoji;
                card.ontouchstart = (e) => {
                    e.preventDefault();
                    if(isGameOver) return;
                    if(flippedCards.length < 2 && !card.classList.contains('flipped')) {
                        card.classList.add('flipped');
                        card.innerText = emoji;
                        flippedCards.push(card);
                        if(flippedCards.length === 2) {
                            if(flippedCards[0].dataset.val === flippedCards[1].dataset.val) {
                                flippedCards = [];
                                matched++;
                                updateUI(matched, timeLeft);
                                if(matched === 8) endGame("üèÜ VITTORIA! Memoria perfetta!");
                            } else {
                                setTimeout(() => {
                                    if(!isGameOver) {
                                        flippedCards.forEach(c => { c.classList.remove('flipped'); c.innerText = ''; });
                                        flippedCards = [];
                                    }
                                }, 600);
                            }
                        }
                    }
                };
                grid.appendChild(card);
            });
        }

        // --------------------------------------------------------
        // 3. REFLEX DOT (CSS gestisce i colori)
        // --------------------------------------------------------
        function initReflex() {
            timeLeft = 20;
            currentScore = 0;
            updateUI(0, timeLeft);
            moveDot();
            timerIntervalId = setInterval(() => {
                timeLeft--;
                updateUI(currentScore, timeLeft);
                if(timeLeft <= 0) {
                    if(currentScore >= 25) endGame("üèÜ VITTORIA! Riflessi Ninja (" + currentScore + ")");
                    else endGame("üê¢ Lento... Fatti: " + currentScore + "/25");
                }
            }, 1000);
        }
        function moveDot() {
            if(isGameOver) return;
            const area = document.getElementById('reflex-area');
            const dot = document.getElementById('target-dot');
            const x = Math.floor(Math.random() * (area.clientWidth - 70));
            const y = Math.floor(Math.random() * (area.clientHeight - 70));
            dot.style.display = 'block';
            dot.style.left = x + 'px';
            dot.style.top = y + 'px';
        }
        window.hitTarget = function(e) {
            e.preventDefault();
            if(isGameOver) return;
            currentScore++;
            updateUI(currentScore, timeLeft);
            moveDot();
        }

        // --------------------------------------------------------
        // 4. SCHIVA TUTTO (Palette Update)
        // --------------------------------------------------------
        function initDodger() {
            const canvas = document.getElementById('canvas-dodger');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 0.95;
            canvas.height = window.innerHeight * 0.7;
            
            let playerX = canvas.width / 2 - 20;
            let obstacles = [];
            currentScore = 0;
            updateUI(0, null);

            canvas.ontouchstart = (e) => {
                e.preventDefault();
                let touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
                if(touchX < canvas.width / 2) playerX -= 50;
                else playerX += 50;
                if(playerX < 0) playerX = 0;
                if(playerX > canvas.width - 40) playerX = canvas.width - 40;
            };

            function loop() {
                if(isGameOver) return;
                // Sfondo
                ctx.fillStyle = COLORS.bg;
                ctx.fillRect(0,0,canvas.width, canvas.height);
                
                // Player (Bianco)
                ctx.fillStyle = COLORS.player;
                ctx.fillRect(playerX, canvas.height - 60, 40, 40);

                if(Math.random() < 0.04) obstacles.push({x: Math.random() * (canvas.width - 40), y: -40});

                // Ostacoli (Rosso acceso)
                ctx.fillStyle = COLORS.obstacle;
                for(let i = obstacles.length - 1; i >= 0; i--) {
                    let o = obstacles[i];
                    o.y += 6;
                    ctx.fillRect(o.x, o.y, 40, 40);
                    
                    // Contorno per visibilit√†
                    ctx.strokeStyle = COLORS.player;
                    ctx.strokeRect(o.x, o.y, 40, 40);

                    if(o.y > canvas.height - 100 && o.y < canvas.height - 20 && o.x < playerX + 40 && o.x + 40 > playerX) {
                        endGame("üí• SCHIANTATO! Punteggio: " + currentScore);
                        return;
                    }
                    if(o.y > canvas.height) { 
                        obstacles.splice(i, 1); 
                        currentScore++; 
                        updateUI(currentScore, null);
                        if(currentScore >= 25) { endGame("üèÜ CAMPIONE! 25 Ostacoli schivati!"); return; }
                    }
                }
                gameLoopId = requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>
